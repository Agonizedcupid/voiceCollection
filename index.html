<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Live input record and playback</title>

  <style type='text/css'>

    #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/4.1.5/firebase.js"></script>
  <script>
      // Initialize Firebase
      var config = {
          apiKey: "AIzaSyBtGYABHzNh41B9M-OJc6yNbqLe8VZxY94",
          authDomain: "voicecollect-5c536.firebaseapp.com",
          databaseURL: "https://voicecollect-5c536.firebaseio.com",
          projectId: "voicecollect-5c536",
          storageBucket: "voicecollect-5c536.appspot.com",
          messagingSenderId: "669484910928"
      };
      firebase.initializeApp(config);
  </script>
  <script src="recorder.js"></script>
  <script src="fileRead.js"></script>
    <script>
        var index = 0;
        var currentFileName = "";
        function next(){
            //index = (parseInt(Math.random()*100)) % 100;
            index = (index+1)%102;
            console.log(index);
            recordingslist.innerHTML = "";
            loadText("showText", index);
        }

    </script>
</head>
<body>
    <h2>Instructions</h2>
    <ul style="font-size: 18px;">
        <li>Please connect your earphone/headphone and give permission (if you're using
        Google Chrome) to use your microphone.</li>
        <li>Click the record button and speak out the line that appears.</li>
        <li>Click stop to end recording.</li>
        <li>Click next for a new sentence.</li>
        <li>You may play the recording and discard it if you don't like it.</li>
        <li>The recording doesn't have to be completely clean/devoid of noise,
            some small amount of noise is not an issue.
            Just make sure what you are saying can be heard clearly.</li>
    </ul>
    <h3><div id ="showText" style="font-size: 30px"></div></h3>

    <button onclick="next()" style="font-size: 18px;"> next </button>
    <button onclick="startRecording(this);" style="font-size: 18px;">record</button>
    <button onclick="stopRecording(this);" style="font-size: 18px;" disabled>stop</button>
  
  <h2>Recording</h2>
  <ul style="list-style: none" id="recordingslist"></ul>

  <pre id="log"></pre>

  <script>

  function __log(e, data) {
  }

  var audio_context;
  var recorder;

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');

    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');
    
    recorder = new Recorder(input);
    __log('Recorder initialised.');
  }

  function startRecording(button) {
    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    __log('Recording...');
  }

  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    __log('Stopped recording.');
    
    // create WAV download link using audio data blob
    createDownloadLink();

    recorder.clear();
  }
  function discard(){
      if(currentFileName != ""){
          var storageRef = firebase.storage().ref();
          var discardRef = storageRef.child(currentFileName);

          // Delete the file
          discardRef.delete().then(function() {
              console.log("file discarded");
              document.getElementById("recordingslist").innerHTML = "";
          }).catch(function(error) {
              console.log("error occurred");
          });


      }
  }

  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');
      var button = document.createElement('button');
      var filename = index + "_" + new Date().toISOString() + '.wav';
      currentFileName = filename;
      au.controls = true;
      au.src = url;
      hf.href = url;
      hf.download = filename;
      hf.innerHTML = hf.download;
      button.onclick = discard;
      button.innerHTML = "discard";
      li.appendChild(au);
      li.appendChild(hf);
      li.appendChild(button);
      recordingslist.innerHTML = "";
      recordingslist.appendChild(li);
      var storageRef = firebase.storage().ref();
      var voiceRef = storageRef.child(filename);
        //var voiceSoundRef = storageRef.child('sounds/'+filename);
        voiceRef.put(blob).then(function(snapshot){
            console.log('Uploaded a blob or file!');
		});
		//next();
    });
  }

  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      
      audio_context = new AudioContext;
      __log('Audio context set up.');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
      alert('No web audio support in this browser!');
    }

      navigator.getUserMedia = ( navigator.getUserMedia ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia ||
                              navigator.msGetUserMedia);

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
    LoadFile();

  };
  </script>
</body>
</html>
